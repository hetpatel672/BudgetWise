name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint
      run: |
        if [ -f "package.json" ] && grep -q "lint" package.json; then
          npm run lint
        else
          echo "No lint script found, skipping..."
        fi
        
    - name: Run Tests
      run: |
        if [ -f "package.json" ] && grep -q "test" package.json; then
          npm test
        else
          echo "No test script found, skipping..."
        fi
        
    - name: Check TypeScript
      run: |
        if [ -f "tsconfig.json" ]; then
          npx tsc --noEmit
        else
          echo "No TypeScript config found, skipping..."
        fi

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    strategy:
      matrix:
        platform: [android, ios]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup Java (Android only)
      if: matrix.platform == 'android'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK (Android only)
      if: matrix.platform == 'android'
      uses: android-actions/setup-android@v3
      
    - name: Check Android build files
      if: matrix.platform == 'android'
      run: |
        echo "ğŸ“± Checking Android build configuration..."
        if [ -f "android/build.gradle" ]; then
          echo "âœ… Android build.gradle found"
        else
          echo "âŒ Android build.gradle not found"
          exit 1
        fi
        
        if [ -f "android/app/build.gradle" ]; then
          echo "âœ… Android app build.gradle found"
        else
          echo "âŒ Android app build.gradle not found"
          exit 1
        fi
        
        if [ -f "android/gradlew" ]; then
          echo "âœ… Gradle wrapper found"
          chmod +x android/gradlew
        else
          echo "âŒ Gradle wrapper not found"
          exit 1
        fi
        
    - name: Check iOS build files
      if: matrix.platform == 'ios'
      run: |
        echo "ğŸ Checking iOS build configuration..."
        if [ -d "ios" ]; then
          echo "âœ… iOS directory found"
        else
          echo "âŒ iOS directory not found"
          exit 1
        fi
        
        if [ -f "ios/Podfile" ]; then
          echo "âœ… Podfile found"
        else
          echo "âŒ Podfile not found"
          exit 1
        fi
        
        if find ios -name "*.xcodeproj" -o -name "*.xcworkspace" | grep -q .; then
          echo "âœ… Xcode project/workspace found"
        else
          echo "âŒ No Xcode project or workspace found"
          exit 1
        fi
        
    - name: Validate package.json
      run: |
        echo "ğŸ“¦ Validating package.json..."
        node -e "
          const pkg = require('./package.json');
          console.log('âœ… Package name:', pkg.name);
          console.log('âœ… Version:', pkg.version);
          console.log('âœ… React Native version:', pkg.dependencies['react-native'] || 'Not found');
          
          const requiredDeps = [
            'react',
            'react-native',
            'react-native-linear-gradient',
            'react-native-vector-icons',
            'react-native-sqlite-storage',
            'crypto-js',
            'react-native-chart-kit'
          ];
          
          const missing = requiredDeps.filter(dep => !pkg.dependencies[dep]);
          if (missing.length > 0) {
            console.error('âŒ Missing dependencies:', missing);
            process.exit(1);
          } else {
            console.log('âœ… All required dependencies found');
          }
        "
        
    - name: Check Metro configuration
      run: |
        echo "ğŸš‡ Checking Metro configuration..."
        if [ -f "metro.config.js" ]; then
          echo "âœ… Metro config found"
        else
          echo "âš ï¸  Metro config not found (using default)"
        fi
        
    - name: Validate React Native setup
      run: |
        echo "âš›ï¸  Validating React Native setup..."
        
        # Check if index.js exists
        if [ -f "index.js" ]; then
          echo "âœ… index.js found"
        else
          echo "âŒ index.js not found"
          exit 1
        fi
        
        # Check if App component exists
        if [ -f "App.tsx" ] || [ -f "App.js" ]; then
          echo "âœ… App component found"
        else
          echo "âŒ App component not found"
          exit 1
        fi
        
        # Check src directory structure
        if [ -d "src" ]; then
          echo "âœ… src directory found"
          echo "ğŸ“ Source structure:"
          find src -type f -name "*.js" -o -name "*.tsx" -o -name "*.ts" | head -10
        else
          echo "âš ï¸  src directory not found"
        fi

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run npm audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level=moderate || true
        
    - name: Check for sensitive files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        
        # Check for common sensitive files
        sensitive_files=(
          "*.keystore"
          "*.p12"
          "*.mobileprovision"
          ".env"
          "google-services.json"
          "GoogleService-Info.plist"
        )
        
        found_sensitive=false
        for pattern in "${sensitive_files[@]}"; do
          if find . -name "$pattern" -not -path "./node_modules/*" | grep -q .; then
            echo "âš ï¸  Found potentially sensitive file: $pattern"
            found_sensitive=true
          fi
        done
        
        if [ "$found_sensitive" = false ]; then
          echo "âœ… No sensitive files found in repository"
        else
          echo "âš ï¸  Please review sensitive files before committing"
        fi

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint-and-test, build-check, security-check]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "## ğŸ“‹ Build Summary"
        echo ""
        echo "### Results:"
        echo "- ğŸ§ª Lint and Test: ${{ needs.lint-and-test.result }}"
        echo "- ğŸ—ï¸  Build Check: ${{ needs.build-check.result }}"
        echo "- ğŸ”’ Security Check: ${{ needs.security-check.result }}"
        echo ""
        
        if [ "${{ needs.lint-and-test.result }}" = "success" ] && \
           [ "${{ needs.build-check.result }}" = "success" ] && \
           [ "${{ needs.security-check.result }}" = "success" ]; then
          echo "âœ… All checks passed! Ready for build and deployment."
        else
          echo "âŒ Some checks failed. Please review the logs."
          exit 1
        fi